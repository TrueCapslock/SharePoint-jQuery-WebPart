<DIV id=configBox>
    <TABLE class=table>
        <THEAD class=thead>
        <TR>
            <TH class="thTop th" colSpan=2>News Rotator- Configuration</TH>
        </TR>
        </THEAD>
        <TBODY class=tbody>
        <TR>
            <TD class=tdOverview>Overview</TD>
            <TD class=tdOverviewField>Here you can change the how the news rotator looks and behaves.</TD>
        </TR>
        </TBODY>
    </TABLE>
    <TABLE class=table>
        <THEAD class=thead>
        <TR>
            <TH class=th colSpan=2>OPTIONS</TH>
        </TR>
        </THEAD>
        <TBODY class=tbody>
        <!--This section outlines the options available to the enduser to change.
        The variable for the script is the derived from the value provided.
        There are 10 listed and commented out till needed.  Uncomment to use.
        Best practice is to use the Rich Text Editor to change the Option, Value
        and Help field vs editing in HTML editor.-->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class="tdOptionField ">Image library</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=imgLibrary class=tdValueField>Spotlight</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Specify what image library to get images from.</TD>
        </TR>
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class="tdOptionField ">Site</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=siteUrl class=tdValueField>/</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Specify what site the image library is in (leave blank if it is in the same site as
                the web part).
            </TD>
        </TR>
        <!-- -->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class=tdOptionField>Show description banner</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=showTextLayer class=tdValueField>true</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Set to true if you want to show a semi transparent banner with title and
                description.
            </TD>
        </TR>
        <!-- -->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class=tdOptionField>Image size</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=imageSize class=tdValueField>web</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Specify what picture size to use.<BR>thumb - (hight or width = 160)<BR>web - (hight or
                width = 640)<BR>original - (original size).
            </TD>
        </TR>
        <!-- -->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class=tdOptionField>Max image width</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=maxW class=tdValueField>233</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Max width of image if you want other size than preset in image size type.</TD>
        </TR>
        <!-- -->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class=tdOptionField>Rotation Interval</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=interval class=tdValueField>6</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Rotation interval in seconds.</TD>
        </TR>
        <!-- -->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class=tdOptionField>Number of images</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=maxImages class=tdValueField>10</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Number of images to get from library (gets the first n pictures from library).</TD>
        </TR>
        <!-- -->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class=tdOptionField>Scope</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=scope class=tdValueField>Recursive</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>If set to "Recursive", it will get images in subfolder as well.</TD>
        </TR>
        <!-- -->
        <TR>
            <TD class=tdOption>Option</TD>
            <TD class=tdOptionField>Transition time</TD>
        </TR>
        <TR>
            <TD class=tdValue>Value</TD>
            <TD id=transitionTime class=tdValueField>2</TD>
        </TR>
        <TR>
            <TD class=tdHelp>Help</TD>
            <TD class=tdHelpField>Specify the transition time between images in seconds.</TD>
        </TR>
        <TR>
            <TD class="tdBBorder line" colSpan=2>---- Change only the gray boxes on this page. ----</TD>
        </TR>
        </TBODY>
    </TABLE>
    <!-- This section covers the Do Not change area. -->
    <P class=line>Please do not Edit, Change or Add any information below this line.</P>
    <HR>
</DIV><!-- This section covers the Solution Info table.  Recommended to change the values using the Rich Text Editor. -->
<DIV style="DISPLAY: none" id=infoBox>
    <TABLE class=tableInfo>
        <TBODY>
        <TR>
            <TD class="tdInfoOption ms-vb" colSpan=2>Click <strong>Rich Text Editor</strong> to change options</TD>
        </TR>
        </TBODY>
    </TABLE>
    <TABLE class=tableInfo>
        <THEAD>
        <TR>
            <TH class=thInfo colSpan=2>Web part Info</TH>
        </TR>
        </THEAD>
        <TBODY>
        <TR>
            <TD class="tdInfoLabel ms-vb">Title:</TD>
            <TD class="tdInfo ms-vb">News Rotator</TD>
        </TR>
        <TR>
            <TD class="tdInfoLabel ms-vb">Details:</TD>
            <TD class="tdInfo ms-vb">This web part will rotate images in a picture library, and display the title and a
                description if it exist.
            </TD>
        </TR>
        <TR>
            <TD class="tdInfoLabel ms-vb">Author:</TD>
            <TD class="tdInfo ms-vb">Ole Hartvig</TD>
        </TR>
        <TR>
            <TD class="tdInfoLabel ms-vb">Version:</TD>
            <TD class="tdInfo ms-vb">1.0</TD>
        </TR>
        </TBODY>
    </TABLE>
</DIV>

<STYLE type=text/css>
    /* This CSS Section covers the news rotator. */
    div#rotator {
        position: relative; /*height: 120px; */;
        width: 258px;
        border: 1px solid #cccccc;
        padding: 10px;
    }

    .news_item {
        border: 0 solid #cccccc;
        position: absolute;
    }

    .news_item img {
        background-color: #FFFFFF;
        border: 0;
    }

    #SlideShowData div.show {
        z-index: 500;
    }

    #SlideShowData span {
        z-index: -1;
    }

    #SlideShowData span.show {
        z-index: 600;
    }

    .block {
        position: absolute;
        font: 9pt Arial, Helvetica, sans-serif;
        padding: 10px 13px;
        background-color: #000000;
        filter: alpha(opacity = 70);
        -moz-opacity: 0.7;
        -khtml-opacity: 0.7;
        opacity: 0.7;
        color: #FFFFFF;
        left: 0;
        bottom: 3px;
    }

    /* This CSS section covers the Configuration table. */
    #configBox {
        display: none;
    }

    .table {
        margin: 1em;
        border-collapse: collapse;
        width: 95%;
    }

    .th {
        padding: .3em;
        border: 1px #000000 solid;
        vertical-align: top;
    }

    .tdOverview {
        padding: .3em;
        border: 1px #000000 solid;
        vertical-align: top;
        width: 50px;
    }

    .tdOverviewField {
        padding: .3em;
        border: 1px #000000 solid;
        vertical-align: top;
    }

    .tdOption {
        padding: .3em;
        border: 1px #000000 solid;
        vertical-align: top;
        width: 50px;
    }

    .tdOptionField {
        padding: .3em;
        border: 1px #000000 solid;
        vertical-align: top;
        font-weight: bold;
    }

    .tdValue {
        padding: .3em;
        border: 1px #000000 solid;
        vertical-align: top;
        width: 50px;
    }

    .tdValueField {
        padding: .3em;
        border: 1px #000000 solid;
        vertical-align: top;
        background: #DCDCDC;
        vertical-align: top;
    }

    .tdHelp {
        padding: .3em;
        border: 1px #000000 solid;
        border-bottom: 3px #000000 solid;
        vertical-align: top;
        width: 50px;
    }

    .tdHelpField {
        padding: .3em;
        border: 1px #000000 solid;
        border-bottom: 3px #000000 solid;
        vertical-align: top;
    }

    .thTop {
        font-size: 1.5em;
    }

    .thead {
        background: #6699CC;
    }

    .tbody {
        background: #CAE5FF;
    }

    /* This CSS section covers the Do Not change area. */
    .line {
        text-align: center;
        font-weight: bold;
    }

    /* This CSS section covers the Solution Info table. */
    .tableInfo {
        margin: 1em;
        border-collapse: collapse;
        width: 236px;
    }

    .thInfo {
        padding: .1em;
        border: 1px #E6E6E6 solid;
        border-bottom: 3px #E6E6E6 solid;
        border-top: 3px #E6E6E6 solid;
        vertical-align: top;
    }

    .tdInfo {
        padding: .1em;
        border: 1px #E6E6E6 solid;
        vertical-align: top;
    }

    .tdInfoOption {
        padding: .1em;
        border: 1px #E6E6E6 solid;
        background-color: #E6E6E6;
        vertical-align: top;
        text-align: center;
    }

    .tdInfoLabel {
        text-align: right;
        font-weight: bold;
        width: 50px;
        padding: .3em;
        border: 1px #E6E6E6 solid;
        vertical-align: top;
    }
</STYLE>

<script type="text/javascript">
/*
    if(typeof jQuery=='undefined'){
	    var jQPath="http://ajax.microsoft.com/ajax/jquery/";
	    document.write("<script src='"+jQPath+"jquery-1.3.2.min.js' type='text/javascript'><\/script>");
    }
*/
</script>

<script type="text/javascript">
    if(typeof jQuery=='undefined'){
	    var jQPath="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/";
	    document.write("<script src='"+jQPath+"jquery.min.js' type='text/javascript'><\/script>");
    }
</script>

<SCRIPT type=text/javascript>

// *** Configuration settings ***
// *                            *
// *  Set these variables to    *
// *  configure the web part    *
// *                            *
// ******************************

// This script section identifies the variables and the solution script
// Variables are commented out till needed.

var imgLibrary      = $('#imgLibrary').text();      //"Spotlight";
var siteURL         = $('#siteUrl').text();         //"";
var showTextLayer   = $('#showTextLayer').text();   //true;
var imageSize       = $('#imageSize').text();       //"web";
var maxW            = $('#maxW').text();            //233;
var interval        = $('#interval').text();        //6; // Rotation interval in seconds.
var maxImages       = $('#maxImages').text();       //10; //how many images to rotate between.
var scope           = $('#scope').text();           //"Recursive"; // get images from all folders.
var transitionTime  = $('#transitionTime').text();  //1000;

function getImages() {
    var soapEnv = 
      "<soapenv:Envelope xmlns:soapenv='http://schemas.xmlsoap.org/soap/envelope/'> \
         <soapenv:Body> \
           <GetListItems xmlns='http://schemas.microsoft.com/sharepoint/soap/'> \
             <listName>" + imgLibrary + "</listName> \
             <query> \
               <Query> \
                 <Where> \
                   <Eq> \
                     <FieldRef Name='FSObjType' /> \
                     <Value Type='int'>0</Value> \
                   </Eq> \
                 </Where> \
                 <OrderBy /> \
               </Query> \
             </query> \
             <queryOptions> \
               <QueryOptions> \
                 <ViewAttributes Scope='" + scope + "' /> \
               </QueryOptions> \
             </queryOptions> \
             <viewFields> \
               <ViewFields> \
                 <FieldRef Name='Title' /> \
                 <FieldRef Name='Description' /> \
                 <FieldRef Name='Hyperlink' /> \
                 <FieldRef Name='ImageCreateDate' /> \
               </ViewFields> \
             </viewFields> \
             <rowLimit>" + maxImages + "</rowLimit> \
           </GetListItems> \
         </soapenv:Body> \
       </soapenv:Envelope>";

    $.ajax({
      url: siteURL + "_vti_bin/lists.asmx",
      type: "POST",
      dataType: "xml",
      data: soapEnv,
      complete: ShowImageList,
      async: false,
      contentType: "text/xml; charset=\"utf-8\""
    });
  }

  function ShowImageList(xData, status) {
    //alert(status);
    //alert(xData.responseXML.xml);

    $(xData.responseXML).find("z\\:row").each(function() {
      if(typeof($(this).attr("ows_FileRef")) != "undefined") {
        var newsTitle = (typeof($(this).attr("ows_Title")) != "undefined") ? $(this).attr("ows_Title") : "(no title)";
        var newsLink = (typeof($(this).attr("ows_Hyperlink")) != "undefined") ? $(this).attr("ows_Hyperlink").split(",")[0] : "";
        var newsLinkDesc = (typeof($(this).attr("ows_Hyperlink")) != "undefined") ? $(this).attr("ows_Hyperlink").split(",")[1] : "";

        var newsDateArr = "";
        if(typeof($(this).attr("ows_ImageCreateDate")) != "undefined")
        {
          newsDateArr = $(this).attr("ows_ImageCreateDate").split(" ");
          newsDateArr = newsDateArr[0].split("-");
          var newsDate = newsDateArr[2] + "." + newsDateArr[1] + "." + newsDateArr[0];
        }

        var newsDesc = (typeof($(this).attr("ows_Description")) != "undefined") ? $(this).attr("ows_Description") : "";


        var tmpFileName = $(this).attr("ows_FileLeafRef").replace($(this).attr("ows_ProgId"), '');
        var tmpFilePathName = $(this).attr("ows_FileRef").replace($(this).attr("ows_ProgId"), '');
        var newsImageUrl ="";

        if(imageSize == "thumb") {
            // Use thumbnail picture
            newsImageUrl = "/" + tmpFilePathName .replace(tmpFileName,  "_t/" + tmpFileName); 
            newsImageUrl = newsImageUrl.replace('.', '_') + ".jpg";
            maxW = (maxW > 160) ? 160 : maxW;
        } else if(imageSize == "web") {
            // Use web picture
            newsImageUrl = "/" + tmpFilePathName .replace(tmpFileName,  "_w/" + tmpFileName); 
            newsImageUrl = newsImageUrl.replace('.', '_') + ".jpg";
            maxW = (maxW > 640) ? 640 : maxW;
        } else {
            // Use original picture
            newsImageUrl = "/" + tmpFilePathName + "";
        }

        var appendHTML = "";
        appendHTML += "<div class='news_item'>";
        appendHTML += "  <a href='" + newsLink + "'>";        
        appendHTML += "    <img src='" + newsImageUrl + "' width='" + maxW + "' alt='' />";
        appendHTML += "  </a>";
        if(newsTitle != "(no title)" && showTextLayer == "true") {
          appendHTML += "  <div class='news_desc'>";
          appendHTML += "    <span class='block' style='width: " + maxW +"px;'>";
          appendHTML += "      <strong>" + newsTitle + "</strong><br/>";
          appendHTML += "      " + newsDate + "<br/>";
          appendHTML += "      " + newsDesc + "<br/>";
          appendHTML += "      <a href='" + newsLink + "'>" + newsLinkDesc + "</a>";
          appendHTML += "    </span>";
          appendHTML += "  </div>";
        }
        appendHTML += "</div>";

        $("#SlideShowData").append(appendHTML);
      }
    });
    $('#SlideShowData div:first').addClass('show');
    $('#SlideShowData div:first').children(':last').children(':first').addClass('show');
  }


function theRotator() {
	//Set the opacity of all images to 0
	$('#SlideShowData div.news_item:not(.show)').css({opacity: 0.0});
        $('.block:not(.show)').hide();

	//Get the first image and display it (gets set to full opacity)
	//$('#SlideShowData div.news_item:first').children().children('div.block').show();
        $('.show').show();
	//$('#SlideShowData div.news_item:first').css( { opacity: 1.0 } );

	//Set the height of the divs
        $('div#SlideShowData').animate({height: $('#SlideShowData div:first img').height()}, 10 );
	$('div#rotator').animate({height: $('#SlideShowData div:first img').height()+20}, 10);
	// Old //$('#SlideShowData div:first img').children(':first').height()

	//Call the rotator function to run the slideshow, 6000 = change to next image after 6 seconds
	setInterval('rotate()',interval * 1000);
	
}

function rotate() {	
	//Get the first image
	var current = ($('#SlideShowData div.show')?  $('#SlideShowData div.show') : $('#SlideShowData div:first'));

	//Get next image, when it reaches the end, rotate it back to the first image
	var next = ((current.next().length) ? ((current.next().hasClass('show')) ? $('#SlideShowData div:first') :current.next()) : $('#SlideShowData div:first'));	
	
	//Set the fade in effect for the next image, the show class has higher z-index
    next.children(':last').children(':first').addClass('show');
    next.css({opacity: 0.0})
	    .addClass('show')
	    .animate({opacity: 1.0}, transitionTime * 1000 );

	//Hide the current image
    current.children(':last').children(':first').removeClass('show');
	current.animate({opacity: 0.0}, transitionTime * 1000 )
	    .removeClass("show");

    $("span.block:not(.show)").hide();
    $("span.show").show();

    if(!($("div#SlideShowData").height() == next.children(":first").height())) {
	    $("div#SlideShowData").animate({height: next.children(":first").height()}, transitionTime * 1000 );
        $("div#rotator").animate({height: next.children(":first").height()+20}, transitionTime * 1000 );
    }
}

function IsInDesignMode()
{
    if(document.getElementById("MSOLayout_InDesignMode").value == '1')
        return true;

    if(document.getElementById("MSOTlPn_SelectedWpId").value != "")
        return true;

    return false;
}

$(document).ready(function() {		
    /** This code runs when everything has been loaded on the page */

    if(IsInDesignMode()) {
        $("#infoBox").show();
    } else {
        //Load the slideshow
        if(imgLibrary != "") {
            getImages();
            theRotator();
        } else {
            $("#SlideShowData").append("The image library setting is not set.");
        }
    }
});
</SCRIPT>

<DIV id="rotator">
<DIV id="SlideShowData"></DIV></DIV>